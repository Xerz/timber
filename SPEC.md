# Техзадание: стартовый экран (Tauri)

**Контекст и цель**
Сделать лаунчер с плитками игр «как на сайте» (допускаются отличия hover‑подсветки). Данные берутся по API, карточки кликабельны и запускают игру. Desktop закрывает лаунчер без запуска exe. Реализация: Tauri 2 (Rust backend + web UI). Нужна возможность разработки и UI‑тестов на macOS.

**Ключевое решение по UI**
Используем HTML/CSS и локальную копию стилей сайта (`src/index.min.css`) для максимального сходства. Дополнительные стили — в `src/styles.css`.

**Объем работ (актуально)**
- Получение токена и UUID станции (Windows Registry, на macOS — env‑переменные для разработки).
- Запрос списка доступных игр и фильтрация `enabled` (+ `verified == READY`, если поле есть).
- Запрос справочника продуктов (картинки, метаданные).
- Запрос названия и описания сервера, а также железа для модалок.
- Рендеринг плиток и интерактивность (hover, click).
- Показ прогресса загрузки.
- Запуск игры при клике (без закрытия окна), Desktop закрывает лаунчер.

**Требования к данным**
- Реестр:
  - `HKLM\SOFTWARE\ITKey\Esme` ключ `last_server` -> `station_uuid`.
  - `HKLM\SOFTWARE\ITKey\Esme\servers\{station_uuid}` ключ `auth_token` -> `token`.
- API:
  - Список игр + параметры запуска (с авторизацией):
    `GET https://services.drova.io/product-manager/serverproduct/list/{station_uuid}`
  - Каталог продуктов (без авторизации):
    `GET https://services.drova.io/product-manager/product/listfull2?limit=2000`
  - Инфо о сервере (без авторизации):
    `GET https://services.drova.io/server-manager/servers/public/{station_uuid}`
  - Железо сервера (без авторизации):
    `GET https://services.drova.io/server-manager/hardware/list/{station_uuid}`
- Заголовок авторизации: `X-Auth-Token: <token>` (только для списка игр).

**Правила отбора игр**
- Игра отображается, если `enabled == true`.
- Если присутствует поле `verified`, то требуется `verified == READY` (case‑insensitive).

**Правила отображения карточки**
- Фоновая картинка: `cardPicture`.
- Заголовок: `displayName` (fallback: `title` из каталога, затем `title` из списка игр, затем “Игра”).
- Alt/tooltip: первые 100 символов `descriptionRu` (по символам).
- Бейдж `requiredAccount` показывается, если поле не пустое.
- Бейдж “Бесплатная” показывается, если `noLicenseRequred == true`.
- Если картинка недоступна — показывать плейсхолдер.

**Определение Desktop**
- `product_id == 9fd0eb43-b2bb-4ce3-93b8-9df63f209098`, или
- `title == "desktop"` (case‑insensitive), или
- `displayName == "Рабочий стол"`.
- Поля `useDefaultDesktop` не используются.
- Фолбэк‑карточка имеет `productId = "desktop"`.

**Правила запуска**
- При клике на карточку UI ставит состояние `is-launching` и, для не‑Desktop, показывает полноэкранный оверлей минимум на 5 секунд.
- Запуск игры: `game_path`, `work_path`, `args`.
- Запуск происходит через `spawn`, ожидание завершения игры отсутствует.
- Для Desktop: окно скрывается и приложение закрывается без запуска exe.

**Состояния UI**
- Инициализация: “Получаем токен и UUID станции…”
- Загрузка списка игр: “Загружаем список игр…”
- Загрузка каталога игр: “Загружаем каталог игр…”
- Загрузка ресурсов: “Загружаем ресурсы…” + счётчик `current/total`
- Готово: прогресс‑лейбл очищается.
- Ошибка: показать модалку с сообщением и кнопкой “Повторить”, вывести fallback‑карточку Desktop.

**Кэширование**
- Включается только при `DROVA_IMAGE_CACHE = 1|true|yes|on`.
- Кэш изображений `cardPicture` в локальной папке (временная директория `drova-launcher/images`).
- TTL кэша: 24 часа.
- Имя файла: SHA1 от URL + расширение из URL.

**Архитектура**
- Rust (Tauri):
  - Реестр, HTTP, кэш, сборка карточек.
  - Команды `load_cards`, `load_station_details` и `launch_game`.
  - События прогресса через `app.emit("status")`.
- UI (HTML/CSS/JS):
  - Отрисовка карточек.
  - Модалки описания сервера и железа.
  - Слушатель статусов.
  - Вызов `load_cards`, `load_station_details` и `launch_game` через Tauri API.

**Совместимость с разработкой на macOS**
- UI тестируется через `?mock=1` и Playwright (`public/mock-data.json`).
- Бэкенд на macOS можно запускать при наличии `DROVA_STATION_UUID` и `DROVA_AUTH_TOKEN`.
- Поддерживается `.env` файл (dotenv).

**Критерии приемки (фактическое поведение)**
- Плитки отображаются как на сайте и реагируют на hover.
- Шапка показывает имя сервера, модалки открываются.
- При клике запускается `exe` (кроме Desktop); окно не закрывается.
- Desktop закрывает лаунчер без запуска exe.
- Во время загрузки виден прогресс.
- При ошибке доступна “Повторить” и fallback‑Desktop.
